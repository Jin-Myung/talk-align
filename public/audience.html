<!doctype html><meta charset="utf-8">
<title>Audience</title>
<style>
    body {
        background: #000;
        color: #eee;
        font: 45px/1.2 system-ui, sans-serif;
        margin: 0;
        padding: 40px;
        overflow-y: auto;
    }

    .para {
        margin-bottom: 0.4em;
        padding: 0.2em 0.4em;
        border-radius: 8px;
        transition: background 0.4s, color 0.4s, transform 0.2s ease;
    }

    .para.highlight {
        background: #555;
        color: #fff;
        transform: scale(1.02);
    }

    .para.dim {
        color: #bbb;
    }

    #container {
        max-width: 90vw;
        margin: auto;
    }
</style>

<div id="container"></div>

<script>
    const ws = new WebSocket(`ws://${location.host}/ws`);
    const container = document.getElementById('container');

    let paragraphs = [];
    let currentIdx = 0;

    ws.onmessage = (e) => {
        try {
            const d = JSON.parse(e.data || '{}');

            if (d.type === 'init_paras') {
                container.innerHTML = '';
                paragraphs = d.en || [];
                renderParagraphs();
                highlight(currentIdx);
            }

            if (d.type === 'para_match') {
                const idx = d.para_idx || 0;
                highlight(idx);
            }
        } catch(_){}
    };

    function renderParagraphs() {
        container.innerHTML = '';
        for (let i = 0; i < paragraphs.length; i++) {
            const div = document.createElement('div');
            div.className = 'para';
            div.textContent = paragraphs[i];
            container.appendChild(div);
        }
    }

    function highlight(idx) {
        currentIdx = idx;
        const all = container.querySelectorAll('.para');
        all.forEach((el, i) => {
            el.classList.toggle('highlight', i === idx);
            el.classList.toggle('dim', i !== idx);
        });

        const active = all[idx];
        if (active) {
            active.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
</script>
