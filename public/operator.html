<!doctype html><meta charset="utf-8">
<title>Operator</title>
<style>
  body {
    font: 16px/1.4 system-ui, sans-serif;
    margin: 0;
    background: #fafafa;
    color: #222;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  header {
    background: #333;
    color: #fff;
    padding: 10px 16px;
    font-size: 18px;
    font-weight: 600;
  }

  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  .panel {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    border-right: 1px solid #ddd;
  }
  .panel:last-child { border-right: none; }

  .para {
    padding: 8px 10px;
    margin-bottom: 10px;
    border-radius: 6px;
    transition: background 0.25s;
    display: flex;
    align-items: flex-start;
  }

  .pnum {
    display: inline-block;
    min-width: 2em;
    margin-right: 6px;
    font-weight: 700;
    color: #777;
  }

  .para.highlight {
    background: #fff8b3;
  }

  /* Status panel */
  .status-panel {
    background: #e9eef3;
    border-top: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
    padding: 10px 16px;
    font-size: 15px;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
  }
  .status-label {
    font-weight: 600;
    color: #333;
    margin-right: 6px;
  }
  .status-value {
    font-family: monospace;
    background: #fff;
    padding: 2px 6px;
    border-radius: 4px;
  }

  .buttons {
    display: flex;
    justify-content: center;
    padding: 10px;
    background: #eee;
    border-top: 1px solid #ccc;
    gap: 20px;
  }
  button {
    font-size: 15px;
    padding: 8px 14px;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  #status {
    background: #f5f5f5;
    padding: 8px 12px;
    border-top: 1px solid #ccc;
    font-family: monospace;
    font-size: 13px;
    line-height: 1.3;
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
  }

  .log-line { margin: 2px 0; }
  .log-time { color: #999; margin-right: 6px; }
  .log-text { color: #222; }
  .log-match { color: #007a00; font-weight: 600; }
  .log-nomatch { color: #a33; font-weight: 600; }
</style>

<header>Operator Console</header>

<main>
  <div id="koPanel" class="panel"></div>
  <div id="enPanel" class="panel"></div>
</main>

<div class="status-panel">
  <span class="status-label">üìç</span>
  <span id="position" class="status-value">-.-</span>
  <span class="status-label">üí¨</span>
  <span id="recognized" class="status-value" style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">‚Äî</span>
</div>

<div class="buttons">
  <button id="btnPrev">‚ñ≤</button>
  <button id="btnNext">‚ñº</button>
</div>

<div id="status"><div id="log"></div></div>

<script>
  const ws = new WebSocket(`ws://${location.host}/ws`);
  const koPanel = document.getElementById('koPanel');
  const enPanel = document.getElementById('enPanel');
  const log = document.getElementById('log');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');

  const position = document.getElementById('position');
  const recognized = document.getElementById('recognized');

  let paragraphsKO = [];
  let paragraphsEN = [];
  let lastMatchedParaIdx = -1;
  let lastSentenceId = "-";
  let buttonsLocked = false;
  let lockTimer = null;

  function send(o){ ws.send(JSON.stringify(o)); }

  ws.onmessage = (e) => {
    try {
      const d = JSON.parse(e.data || '{}');
      if (d.type === 'init_paras') {
        paragraphsKO = d.ko || [];
        paragraphsEN = d.en || [];
        renderPanels();
      }
      else if (d.type === 'para_match') {
        const newIdx = d.para_idx || 0;
        if (newIdx !== lastMatchedParaIdx) {
          highlight(newIdx);
          addLog(`Matched paragraph ${newIdx + 1}`, true);
          lastMatchedParaIdx = newIdx;
          updatePosition(newIdx + 1, lastSentenceId);
        }
      }
      else if (d.type === 'recognize') {
        recognized.textContent = d.text;
        addLog(`Recognized: ${d.text}`, false);
      }
      else if (d.type === 'match') {
        if (d.tag) {
          lastSentenceId = d.tag.split('.')[1] || "-";
          const paraIdx = cur_para_idx_from_tag(d.tag);
          updatePosition(paraIdx + 1, lastSentenceId);
        }
      }
      else if (d.type === 'info') {
        addLog(d.msg || 'Info message', false, true);
      }
    } catch(_){}
  };

  function cur_para_idx_from_tag(tag){
    if (!tag) return 0;
    const parts = tag.split('.');
    return parseInt(parts[0], 10) - 1 || 0;
  }

  function updatePosition(paraNum, sentNum){
    position.textContent = `${paraNum}.${sentNum || "-"}`;
  }

  function renderPanels(){
    koPanel.innerHTML = '';
    enPanel.innerHTML = '';
    for (let i = 0; i < paragraphsKO.length; i++){
      const p1 = document.createElement('div');
      p1.className = 'para';
      p1.id = `ko-p${i}`;
      p1.innerHTML = `<span class="pnum">${i+1}.</span><span>${paragraphsKO[i]}</span>`;
      koPanel.appendChild(p1);

      const p2 = document.createElement('div');
      p2.className = 'para';
      p2.id = `en-p${i}`;
      p2.innerHTML = `<span class="pnum">${i+1}.</span><span>${paragraphsEN[i]}</span>`;
      enPanel.appendChild(p2);
    }
  }

  function highlight(idx){
    const allKO = koPanel.querySelectorAll('.para');
    const allEN = enPanel.querySelectorAll('.para');
    allKO.forEach((el,i)=>el.classList.toggle('highlight', i===idx));
    allEN.forEach((el,i)=>el.classList.toggle('highlight', i===idx));

    const activeKO = document.getElementById(`ko-p${idx}`);
    const activeEN = document.getElementById(`en-p${idx}`);
    if (activeKO) activeKO.scrollIntoView({behavior:'smooth', block:'center'});
    if (activeEN) activeEN.scrollIntoView({behavior:'smooth', block:'center'});
  }

  function addLog(msg, isMatch=false, isInfo=false){
    const line = document.createElement('div');
    line.className = 'log-line';
    const t = document.createElement('span');
    t.className = 'log-time';
    t.textContent = `[${new Date().toLocaleTimeString()}] `;
    const m = document.createElement('span');
    m.className = 'log-text';
    if (isMatch) m.classList.add('log-match');
    if (isInfo) m.classList.add('log-nomatch');
    m.textContent = msg;
    line.appendChild(t);
    line.appendChild(m);
    log.appendChild(line);
    const lines = log.querySelectorAll('.log-line');
    if (lines.length > 6) log.removeChild(lines[0]);
    log.scrollTop = log.scrollHeight;
  }

  function lockButtons(durationMs = 1000) {
    if (buttonsLocked) return;
    buttonsLocked = true;
    btnPrev.disabled = true;
    btnNext.disabled = true;
    clearTimeout(lockTimer);
    lockTimer = setTimeout(() => {
      buttonsLocked = false;
      btnPrev.disabled = false;
      btnNext.disabled = false;
    }, durationMs);
  }

  function handleMove(direction) {
    if (buttonsLocked) return;
    lockButtons();
    send({type: direction});
  }

  btnPrev.addEventListener('click', () => handleMove('prev'));
  btnNext.addEventListener('click', () => handleMove('next'));

  // ‚úÖ ÌÇ§Î≥¥Îìú ‚Üë ‚Üì Î°ú Ï†úÏñ¥
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      handleMove('prev');
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      handleMove('next');
    }
  });
</script>
