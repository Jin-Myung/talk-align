<!doctype html><meta charset="utf-8">
<title>Operator</title>
<style>
  body {
    font: 16px/1.4 system-ui, sans-serif;
    margin: 0;
    background: #fafafa;
    color: #222;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  header {
    background: #333;
    color: #fff;
    padding: 10px 16px;
    font-size: 18px;
    font-weight: 600;
  }

  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  .panel {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    border-right: 1px solid #ddd;
  }
  .panel:last-child {
    border-right: none;
  }

  .para {
    padding: 8px 10px;
    margin-bottom: 10px;
    border-radius: 6px;
    transition: background 0.25s;
  }
  .para.highlight {
    background: #fff8b3;
  }

  .buttons {
    display: flex;
    justify-content: center;
    padding: 10px;
    background: #eee;
    border-top: 1px solid #ccc;
  }
  button {
    font-size: 15px;
    padding: 8px 14px;
    margin: 0 10px;
    cursor: pointer;
  }

  #status {
    background: #f5f5f5;
    padding: 8px 12px;
    border-top: 1px solid #ccc;
    font-family: monospace;
    font-size: 13px;
    line-height: 1.3;
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
  }

  .log-line { margin: 2px 0; }
  .log-time { color: #999; margin-right: 6px; }
  .log-text { color: #222; }
  .log-match { color: #007a00; font-weight: 600; }
  .log-nomatch { color: #a33; font-weight: 600; }
</style>

<header>Operator Console</header>

<main>
  <div id="koPanel" class="panel"></div>
  <div id="enPanel" class="panel"></div>
</main>

<div class="buttons">
  <button id="btnPrev">▲ Previous Paragraph</button>
  <button id="btnNext">▼ Next Paragraph</button>
</div>

<div id="status">
  <div id="log"></div>
</div>

<script>
  const ws = new WebSocket(`ws://${location.host}/ws`);
  const koPanel = document.getElementById('koPanel');
  const enPanel = document.getElementById('enPanel');
  const log = document.getElementById('log');

  let paragraphsKO = [];
  let paragraphsEN = [];
  let curIdx = 0;

  function send(o){ ws.send(JSON.stringify(o)); }

  ws.onmessage = (e) => {
    try {
      const d = JSON.parse(e.data || '{}');

      if (d.type === 'init_paras') {
        paragraphsKO = d.ko || [];
        paragraphsEN = d.en || [];
        renderPanels();
        highlight(curIdx);
      }
      else if (d.type === 'para_match') {
        highlight(d.para_idx || 0);
        addLog(`Matched paragraph ${d.para_idx+1}`, true);
      }
      else if (d.type === 'recognize') {
        addLog(`Recognized: ${d.text}`, false);
      }
      else if (d.type === 'info') {
        addLog(d.msg || 'Info message', false, true);
      }
    } catch(_){}
  };

  /* --- 패널 렌더링 --- */
  function renderPanels(){
    koPanel.innerHTML = '';
    enPanel.innerHTML = '';
    for (let i = 0; i < paragraphsKO.length; i++){
      const p1 = document.createElement('div');
      p1.className = 'para';
      p1.textContent = paragraphsKO[i];
      koPanel.appendChild(p1);

      const p2 = document.createElement('div');
      p2.className = 'para';
      p2.textContent = paragraphsEN[i];
      enPanel.appendChild(p2);
    }
  }

  /* --- 하이라이트 --- */
  function highlight(idx){
    curIdx = idx;
    const allKO = koPanel.querySelectorAll('.para');
    const allEN = enPanel.querySelectorAll('.para');
    allKO.forEach((el,i)=>el.classList.toggle('highlight', i===idx));
    allEN.forEach((el,i)=>el.classList.toggle('highlight', i===idx));

    const activeKO = allKO[idx];
    const activeEN = allEN[idx];
    if (activeKO) activeKO.scrollIntoView({behavior:'smooth', block:'center'});
    if (activeEN) activeEN.scrollIntoView({behavior:'smooth', block:'center'});
  }

  /* --- 로그 --- */
  function addLog(msg, isMatch=false, isInfo=false){
    const line = document.createElement('div');
    line.className = 'log-line';
    const t = document.createElement('span');
    t.className = 'log-time';
    t.textContent = `[${new Date().toLocaleTimeString()}] `;
    const m = document.createElement('span');
    m.className = 'log-text';
    if (isMatch) m.classList.add('log-match');
    if (isInfo) m.classList.add('log-nomatch');
    m.textContent = msg;
    line.appendChild(t);
    line.appendChild(m);
    log.appendChild(line);

    const lines = log.querySelectorAll('.log-line');
    if (lines.length > 6) log.removeChild(lines[0]);
    log.scrollTop = log.scrollHeight;
  }

  /* --- 버튼 동작 --- */
  document.getElementById('btnPrev').addEventListener('click', ()=>{
    curIdx = Math.max(0, curIdx - 1);
    send({type:'prev'});
    highlight(curIdx);
    addLog(`Moved to paragraph ${curIdx+1}`, true);
  });
  document.getElementById('btnNext').addEventListener('click', ()=>{
    curIdx = Math.min(paragraphsKO.length - 1, curIdx + 1);
    send({type:'next'});
    highlight(curIdx);
    addLog(`Moved to paragraph ${curIdx+1}`, true);
  });
</script>
