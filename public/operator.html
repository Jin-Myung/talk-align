<!doctype html><meta charset="utf-8">
<title>Operator</title>
<style>
  body {
    font: 16px/1.4 system-ui, sans-serif;
    margin: 0;
    background: #fafafa;
    color: #222;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  header {
    background: #333;
    color: #fff;
    padding: 10px 16px;
    font-size: 18px;
    font-weight: 600;
  }

  .file-loader {
    background: #eee;
    padding: 8px 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    border-bottom: 1px solid #ccc;
  }
  .file-controls {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .file-loader input[type=file] {
    font-size: 13px;
  }
  .file-loader button {
    padding: 6px 14px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .file-loader button:hover {
    background: #ddd;
  }

  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  .panel {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    border-right: 1px solid #ddd;
  }
  .panel:last-child { border-right: none; }

  .para {
    padding: 8px 10px;
    margin-bottom: 10px;
    border-radius: 6px;
    transition: background 0.25s;
    display: flex;
    align-items: flex-start;
  }

  .pnum {
    display: inline-block;
    min-width: 2em;
    margin-right: 6px;
    font-weight: 700;
    color: #777;
  }

  .para.highlight {
    background: #fff8b3;
  }

  /* Status panel */
  .status-panel {
    background: #e9eef3;
    border-top: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
    padding: 10px 16px;
    font-size: 15px;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
  }
  .mute-btn {
    background: transparent;
    border: none;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.2s, color 0.2s;
    color: #555;
  }
  .mute-btn.active {
    color: #a00;
    transform: scale(1.2);
  }
  .mute-btn:hover {
    opacity: 0.8;
  }
  .status-label {
    font-weight: 600;
    color: #333;
    margin-right: 6px;
  }
  .status-value {
    font-family: monospace;
    background: #fff;
    padding: 2px 6px;
    border-radius: 4px;
  }

  .buttons {
    display: flex;
    justify-content: center;
    padding: 10px;
    background: #eee;
    border-top: 1px solid #ccc;
    gap: 20px;
  }
  button {
    font-size: 15px;
    padding: 8px 14px;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  /* Log container */
  #status {
    background: #f5f5f5;
    border-top: 1px solid #ccc;
    font-family: monospace;
    font-size: 13px;
    line-height: 1.3;
    max-height: 135px;
    overflow: hidden; /* overflow moved to #log */
  }

  #log {
    padding: 8px 12px;
    height: 127px;
    overflow-y: auto; /* scroll here */
    white-space: pre-wrap;
  }

  .log-line { margin: 2px 0; }
  .log-time { color: #999; margin-right: 6px; }
  .log-text { color: #222; }
  .log-match { color: #007a00; font-weight: 600; }
</style>

<header>Talk-Align Console</header>

<!-- File upload banner -->
<div class="file-loader">
  <span id="connStatus" style="font-weight:600;color:#a00;">üî¥ Disconnected</span>
  <div class="file-controls">
    <label>KO Script:</label>
    <input type="file" id="fileKO" accept=".txt">
    <label>EN Prompt:</label>
    <input type="file" id="fileEN" accept=".txt">
    <button id="btnLoad">Load</button>
  </div>
</div>

<!-- Script/prompt panel -->
<main>
  <div id="koPanel" class="panel"></div>
  <div id="enPanel" class="panel"></div>
</main>

<!-- Recognized text -->
<div class="status-panel">
  <button id="btnMute" class="mute-btn" title="Mute microphone">üîá</button>
  <span class="status-label">üìç</span>
  <span id="position" class="status-value">-.-</span>
  <span class="status-label">üí¨</span>
  <span id="recognized" class="status-value" style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">‚Äî</span>
</div>

<!-- Paragraph move buttons -->
<div class="buttons">
  <button id="btnPrev">‚ñ≤</button>
  <button id="btnNext">‚ñº</button>
</div>

<!-- Log messages -->
<div id="status"><div id="log"></div></div>

<script>
  const ws = new WebSocket(`ws://${location.host}/ws`);
  const connStatus = document.getElementById('connStatus');
  const fileKO = document.getElementById('fileKO');
  const fileEN = document.getElementById('fileEN');
  const btnLoad = document.getElementById('btnLoad');
  const koPanel = document.getElementById('koPanel');
  const enPanel = document.getElementById('enPanel');
  const btnMute = document.getElementById('btnMute');
  const position = document.getElementById('position');
  const recognized = document.getElementById('recognized');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const log = document.getElementById('log');

  let connected = false;
  let lastAlive = Date.now();
  let paragraphsKO = [];
  let paragraphsEN = [];
  let lastMatchedParaIdx = -1;
  let lastSentenceId = "-";
  let muted = false;
  let buttonsLocked = false;
  let lockTimer = null;

  function send(o){
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify(o));
    }
  }

  ws.onopen = () => addLog("Socket opened (awaiting heartbeat...)");

  ws.onclose = () => {
    setConnectionState(false)
    addLog("Connection closed. Refresh if needed.");
  }

  ws.onmessage = (e) => {
    try {
      const d = JSON.parse(e.data || '{}');
      if (d.type === 'alive') {
        lastAlive = Date.now();
        if (!connected) {
          setConnectionState(true);
          addLog("Reconnected to server.");
        }
      }
      else if (d.type === 'init_para') {
        paragraphsKO = d.ko || [];
        paragraphsEN = d.en || [];
        renderPanels();
        addLog(`Loaded ${paragraphsKO.length} paragraphs`);
      }
      else if (d.type === 'move_para') {
        const newIdx = d.para_idx || 0;
        if (newIdx !== lastMatchedParaIdx || d.reloading) {
          highlight(newIdx);
          addLog(`Matched paragraph ${newIdx + 1}`, true);
          lastMatchedParaIdx = newIdx;
          lastSentenceId = d.sent_idx + 1;
          updatePosition(newIdx + 1, lastSentenceId);
        }
      }
      else if (d.type === 'recognize') {
        recognized.textContent = d.text;
        addLog(`Recognized: ${d.text}`);
      }
      else if (d.type === 'match_sent') {
        if (d.tag) {
          lastSentenceId = d.tag.split('.')[1] || "-";
          const paraIdx = cur_para_idx_from_tag(d.tag);
          updatePosition(paraIdx + 1, lastSentenceId);
        }
      }
      else if (d.type === 'info') {
        addLog(d.msg || 'Info');
      }
    } catch(_){}
  };

  function cur_para_idx_from_tag(tag){
    if (!tag) return 0;
    const parts = tag.split('.');
    return parseInt(parts[0], 10) - 1 || 0;
  }

  btnLoad.addEventListener('click', async () => {
    const koFile = fileKO.files[0];
    const enFile = fileEN.files[0];
    if (!koFile || !enFile) {
      alert("Specify two files.");
      return;
    }
    const koText = await koFile.text();
    const enText = await enFile.text();
    send({type: "load_files", ko_text: koText, en_text: enText});
    addLog(`Sent files to server: ${koFile.name}, ${enFile.name}`);
  });

  function updatePosition(paraNum, sentNum){
    position.textContent = `${paraNum}.${sentNum || "-"}`;
  }

  function setConnectionState(ok) {
    connected = ok;
    connStatus.textContent = ok ? 'üü¢ Connected' : 'üî¥ Disconnected';
    connStatus.style.color = ok ? "#070" : "#a00";
    btnLoad.disabled = btnPrev.disabled = btnNext.disabled = !ok;
    if (!ok) {
      position.textContent = "-.-";
      recognized.textContent = "-";
    }
    toggleMute(ok);
  }

  function renderPanels(){
    koPanel.innerHTML = '';
    enPanel.innerHTML = '';
    for (let i = 0; i < paragraphsKO.length; i++){
      const p1 = document.createElement('div');
      p1.className = 'para';
      p1.id = `ko-p${i}`;
      p1.innerHTML = `<span class="pnum">${i+1}.</span><span>${paragraphsKO[i]}</span>`;
      koPanel.appendChild(p1);

      const p2 = document.createElement('div');
      p2.className = 'para';
      p2.id = `en-p${i}`;
      p2.innerHTML = `<span class="pnum">${i+1}.</span><span>${paragraphsEN[i]}</span>`;
      enPanel.appendChild(p2);
    }
  }

  function highlight(idx){
    const allKO = koPanel.querySelectorAll('.para');
    const allEN = enPanel.querySelectorAll('.para');
    allKO.forEach((el,i)=>el.classList.toggle('highlight', i===idx));
    allEN.forEach((el,i)=>el.classList.toggle('highlight', i===idx));
    const activeKO = document.getElementById(`ko-p${idx}`);
    const activeEN = document.getElementById(`en-p${idx}`);
    if (activeKO) activeKO.scrollIntoView({behavior:'smooth', block:'center'});
    if (activeEN) activeEN.scrollIntoView({behavior:'smooth', block:'center'});
  }

  function toggleMute(is_muted=true){
    muted = !is_muted;
    btnMute.classList.toggle('active', muted);
    btnMute.title = muted ? "Unmute microphone" : "Mute microphone";
    btnMute.textContent = muted ? "üîà" : "üîá";
    if (muted) {
      recognized.textContent = "-";
    }
    send({ type: 'mute', value: muted });
  }

  function addLog(msg, isMatch=false){
    const nearBottom =
            Math.abs(log.scrollHeight - log.scrollTop - log.clientHeight) < 5;

    const line = document.createElement('div');
    line.className = 'log-line';
    const t = document.createElement('span');
    t.className = 'log-time';
    t.textContent = `[${new Date().toLocaleTimeString('en-US', {hour12:false})}]`;
    const m = document.createElement('span');
    m.className = 'log-text';
    if (isMatch) m.classList.add('log-match');
    m.textContent = msg;
    line.appendChild(t);
    line.appendChild(m);
    log.appendChild(line);

    if (log.children.length > 5000) {
      log.removeChild(log.firstChild);
    }

    if (nearBottom) {
      requestAnimationFrame(() => {
        log.scrollTop = log.scrollHeight;
      });
    }
  }

  function lockButtons(durationMs = 1000) {
    if (buttonsLocked) return;
    buttonsLocked = true;
    btnPrev.disabled = true;
    btnNext.disabled = true;
    clearTimeout(lockTimer);
    lockTimer = setTimeout(() => {
      buttonsLocked = false;
      btnPrev.disabled = false;
      btnNext.disabled = false;
    }, durationMs);
  }

  function handleMove(direction) {
    if (buttonsLocked) return;
    lockButtons();
    send({type: direction});
  }

  setInterval(() => {
    const now = Date.now();
    if (now - lastAlive > 3000 && connected) {
      setConnectionState(false);
      addLog("Connection lost.");
    }
  }, 1000);

  btnMute.addEventListener('click', () => toggleMute(muted));
  btnPrev.addEventListener('click', () => handleMove('prev'));
  btnNext.addEventListener('click', () => handleMove('next'));

  document.addEventListener('keydown', (e) => {
    if (connected) {
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        handleMove('prev');
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        handleMove('next');
      }
    }
  });
</script>
